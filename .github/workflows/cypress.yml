name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq and mochawesome
        run: |
          sudo apt-get install -y jq
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
          npm install mochawesome mochawesome-merge mochawesome-report-generator

      - name: Create results directory
        run: mkdir -p cypress/results

      # ‚¨á‚¨á‚¨á –í–ê–ñ–ù–û: –≠–¢–û–¢ –®–ê–ì –û–¢–°–£–¢–°–¢–í–û–í–ê–õ ‚¨á‚¨á‚¨á
      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        id: cypress-run
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          command: npm run test:e2e

      # ‚¨á‚¨á‚¨á –í–ê–ñ–ù–û: –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ‚¨á‚¨á‚¨á
      - name: Merge mochawesome reports
        if: always()
        run: |
          echo "–û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã mochawesome..."
          npx mochawesome-merge cypress/results/*.json > cypress/results/combined-report.json
          echo "‚úÖ –û—Ç—á–µ—Ç—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ cypress/results/combined-report.json"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          ls -la cypress/results/ || echo "–ü–∞–ø–∫–∞ results –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          ls -la cypress/results/*.json 2>/dev/null || echo "JSON —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç"

      - name: Send Telegram notification
          if: always()
          env:
            BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
            CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          run: |
            echo "=== –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ==="
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
            if [ -f "cypress/results/combined-report.json" ]; then
              echo "‚úÖ –ù–∞–π–¥–µ–Ω combined-report.json"
            
              # –ü–∞—Ä—Å–∏–º JSON –æ—Ç—á–µ—Ç mochawesome
              TOTAL_TESTS=$(jq '.stats.tests // 0' cypress/results/combined-report.json)
              PASSED_TESTS=$(jq '.stats.passes // 0' cypress/results/combined-report.json)
              FAILED_TESTS=$(jq '.stats.failures // 0' cypress/results/combined-report.json)
              PENDING_TESTS=$(jq '.stats.pending // 0' cypress/results/combined-report.json)
            
              echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
            
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              if [ "$FAILED_TESTS" -eq 0 ]; then
                STATUS_ICON="‚úÖ"
                STATUS_TEXT="–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
              else
                STATUS_ICON="‚ùå"
                STATUS_TEXT="–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã!"
              fi
            
              # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ - –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
              MESSAGE="$STATUS_ICON Cypress Tests Results
      ========================
      $STATUS_TEXT
      $PASSED_TESTS/$TOTAL_TESTS —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ"
      
      if [ "$FAILED_TESTS" -gt 0 ]; then
      MESSAGE="$MESSAGE
      $FAILED_TESTS —Ç–µ—Å—Ç–æ–≤ —É–ø–∞–ª–∏"
      fi
      
      if [ "$PENDING_TESTS" -gt 0 ]; then
      MESSAGE="$MESSAGE
      $PENDING_TESTS —Ç–µ—Å—Ç–æ–≤ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏"
      fi
      
      # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é GitHub
      MESSAGE="$MESSAGE
      –í–µ—Ç–∫–∞: ${{ github.ref_name }}
      –ê–≤—Ç–æ—Ä: ${{ github.actor }}

      –°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        else
        echo "‚ùå –§–∞–π–ª combined-report.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        
        # –ï—Å–ª–∏ –æ—Ç—á–µ—Ç–∞ –Ω–µ—Ç
        MESSAGE="üß™ Cypress Tests Results
      ========================
      ‚ö†Ô∏è –û—Ç—á–µ—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã
      –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${{ job.status }}
      –í–µ—Ç–∫–∞: ${{ github.ref_name }}
      –ê–≤—Ç–æ—Ä: ${{ github.actor }}

      –°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi
        
        echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram..."
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        curl -s -X POST \
        https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
        -d chat_id="$CHAT_ID" \
        --data-urlencode "text=$MESSAGE" \
        -d "parse_mode=HTML"
        
        echo "üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"