name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq and mochawesome reporter
        run: |
          sudo apt-get install -y jq
          npm install -g mochawesome mochawesome-merge mochawesome-report-generator

      - name: Create results directory
        run: mkdir -p cypress/results

      - name: Run Cypress tests with proper reporting
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          # –í–∞—Ä–∏–∞–Ω—Ç 1: –° mochawesome (–ª—É—á—à–∏–π)
          command: npx cypress run --reporter mochawesome --reporter-options reportDir=cypress/results,overwrite=true,html=false,json=true
          # –ò–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç 2: –° json reporter..
          # command: npx cypress run --reporter json --reporter-options output=cypress/results/results.json
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Process mochawesome results
        if: always()
        run: |
          echo "=== –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ==="
          ls -la cypress/results/
          
          # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º mochawesome, —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è mochawesome.json –∏–ª–∏ mochawesome_001.json –∏ —Ç.–¥.
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ JSON —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ
          if ls cypress/results/mochawesome*.json 1> /dev/null 2>&1; then
            echo "–ù–∞–π–¥–µ–Ω mochawesome –æ—Ç—á–µ—Ç"
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –æ–¥–∏–Ω
            npx mochawesome-merge cypress/results/mochawesome*.json > cypress/results/combined.json
            # –î–µ–ª–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            cp cypress/results/combined.json cypress/results/results.json
          fi
          
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ results.json ==="
          if [ -f "cypress/results/results.json" ] && [ -s "cypress/results/results.json" ]; then
            echo "–§–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π"
            echo "–†–∞–∑–º–µ—Ä: $(wc -c < cypress/results/results.json) –±–∞–π—Ç"
            echo "–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:"
            head -c 200 cypress/results/results.json
            echo ""
          else
            echo "–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            # –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
            echo '{"stats":{"suites":0,"tests":0,"passes":0,"pending":0,"failures":0},"results":[]}' > cypress/results/results.json
          fi

      - name: Send Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -f "cypress/results/results.json" ] || [ ! -s "cypress/results/results.json" ]; then
            echo '{"stats":{"suites":0,"tests":0,"passes":0,"pending":0,"failures":0},"results":[]}' > cypress/results/results.json
          fi
          
          # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          echo "=== –ü–∞—Ä—Å–∏–º JSON ==="
          cat cypress/results/results.json
          
          # Mochawesome —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
          if jq -e '.stats' "cypress/results/results.json" > /dev/null 2>&1; then
            TESTS_TOTAL=$(jq -r '.stats.tests // 0' "cypress/results/results.json")
            TESTS_PASSED=$(jq -r '.stats.passes // 0' "cypress/results/results.json")
            TESTS_FAILED=$(jq -r '.stats.failures // 0' "cypress/results/results.json")
            echo "Mochawesome: –í—Å–µ–≥–æ=$TESTS_TOTAL, –ü—Ä–æ–π–¥–µ–Ω–æ=$TESTS_PASSED, –£–ø–∞–ª–æ=$TESTS_FAILED"
          else
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
            TESTS_TOTAL=$(jq -r '.total // .tests // 0' "cypress/results/results.json")
            TESTS_PASSED=$(jq -r '.passed // .passes // 0' "cypress/results/results.json")
            TESTS_FAILED=$(jq -r '.failed // .failures // 0' "cypress/results/results.json")
            echo "–î—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç: –í—Å–µ–≥–æ=$TESTS_TOTAL, –ü—Ä–æ–π–¥–µ–Ω–æ=$TESTS_PASSED, –£–ø–∞–ª–æ=$TESTS_FAILED"
          fi
          
          # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          TESTS_TOTAL=${TESTS_TOTAL:-0}
          TESTS_PASSED=${TESTS_PASSED:-0}
          TESTS_FAILED=${TESTS_FAILED:-0}
          
          TESTS_TOTAL=$((TESTS_TOTAL))
          TESTS_PASSED=$((TESTS_PASSED))
          TESTS_FAILED=$((TESTS_FAILED))
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üß™ <b>Cypress Tests Report</b>
          ==============================
          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</b>
          ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $TESTS_PASSED
          ‚ùå –£–ø–∞–ª–æ: $TESTS_FAILED
          üìà –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TESTS_TOTAL"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã
          if [ $TESTS_TOTAL -gt 0 ]; then
            PERCENTAGE=$((TESTS_PASSED * 100 / TESTS_TOTAL))
            MESSAGE="$MESSAGE
            üéØ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: $PERCENTAGE%"
          
            # –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            MESSAGE="$MESSAGE
            üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: [$(
              for i in $(seq 1 10); do
                if [ $((i*10)) -le $PERCENTAGE ]; then
                  echo "‚ñà"
                else
                  echo "‚ñë"
                fi
              done | tr -d '\n'
            )]"
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–∞—Ö
          if [ $TESTS_FAILED -gt 0 ]; then
            FAILED_TESTS=$(jq -r '
              [.results[].suites[].tests[] | select(.fail == true or .state == "failed") | .title]
              | join("\n‚Ä¢ ")
            ' "cypress/results/results.json" 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫")
          
            if [ -n "$FAILED_TESTS" ] && [ "$FAILED_TESTS" != "" ]; then
              MESSAGE="$MESSAGE
          
            üî• <b>–£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:</b>
            ‚Ä¢ $FAILED_TESTS"
            fi
          fi
          
          MESSAGE="$MESSAGE
          
          ------------------------
          üîó –î–µ—Ç–∞–ª–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          curl -s -X POST \
            https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"