name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq and mochawesome
        run: |
          sudo apt-get install -y jq
          npm install mochawesome mochawesome-merge mochawesome-report-generator

      - name: Create results directory
        run: mkdir -p cypress/results

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        id: cypress-run
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          command: npm run test:e2e

      - name: Merge mochawesome reports
        if: always()
        run: |
          echo "–û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã mochawesome..."
          npx mochawesome-merge cypress/results/*.json > cypress/results/combined-report.json
          echo "‚úÖ –û—Ç—á–µ—Ç—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ cypress/results/combined-report.json"
          ls -la cypress/results/ || echo "–ü–∞–ø–∫–∞ results –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          ls -la cypress/results/*.json 2>/dev/null || echo "JSON —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç"

      - name: Send Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_BRANCH: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "=== –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ==="
          
          if [ -f "cypress/results/combined-report.json" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω combined-report.json"
          
            TOTAL_TESTS=$(jq '.stats.tests // 0' cypress/results/combined-report.json)
            PASSED_TESTS=$(jq '.stats.passes // 0' cypress/results/combined-report.json)
            FAILED_TESTS=$(jq '.stats.failures // 0' cypress/results/combined-report.json)
            PENDING_TESTS=$(jq '.stats.pending // 0' cypress/results/combined-report.json)
          
            echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          
            if [ "$FAILED_TESTS" -eq 0 ]; then
              STATUS_ICON="‚úÖ"
              STATUS_TEXT="–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
            else
              STATUS_ICON="‚ùå"
              STATUS_TEXT="–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã!"
            fi
          
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏
            MESSAGE="$STATUS_ICON Cypress Tests Results
            ========================
            $STATUS_TEXT
            ‚úÖ $PASSED_TESTS/$TOTAL_TESTS —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ"
  
            if [ "$FAILED_TESTS" -gt 0 ]; then
            MESSAGE="$MESSAGE
            ‚ùå $FAILED_TESTS —Ç–µ—Å—Ç–æ–≤ —É–ø–∞–ª–∏"
            fi
  
            if [ "$PENDING_TESTS" -gt 0 ]; then
            MESSAGE="$MESSAGE
            ‚è≥ $PENDING_TESTS —Ç–µ—Å—Ç–æ–≤ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏"
            fi
            else
            echo "‚ùå –§–∞–π–ª combined-report.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            MESSAGE="üß™ Cypress Tests Results
            ========================
            ‚ö†Ô∏è –û—Ç—á–µ—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã
            –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $JOB_STATUS"
            fi
  
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            MESSAGE="$MESSAGE
            –í–µ—Ç–∫–∞: $GITHUB_BRANCH
            –ê–≤—Ç–æ—Ä: $GITHUB_ACTOR

            –°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥: $GITHUB_RUN_URL"
  
            echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram..."
            echo "–°–æ–æ–±—â–µ–Ω–∏–µ:"
            echo "$MESSAGE"
  
           # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
            curl -s -X POST \
           "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
  
            echo "üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"