name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq for JSON parsing
        run: sudo apt-get install -y jq  # ‚¨Ö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ jq

      - name: Run Cypress tests with JSON report
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          command: npm run test:e2e  # ‚¨ÖÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

      - name: Send detailed Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          if [ -f "cypress/results/results.json" ]; then
            # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
            TESTS_TOTAL=$(jq -r '.total' cypress/results/results.json)
            TESTS_PASSED=$(jq -r '.passed' cypress/results/results.json)
            TESTS_FAILED=$(jq -r '.failed' cypress/results/results.json)
          
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            MESSAGE="üß™ <b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç Cypress Tests</b>
            ==============================
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
            üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</b>
            ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $TESTS_PASSED –∏–∑ $TESTS_TOTAL
            ‚ùå –£–ø–∞–ª–æ: $TESTS_FAILED –∏–∑ $TESTS_TOTAL"
          
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            PERCENTAGE=$((TESTS_PASSED * 100 / TESTS_TOTAL))
            MESSAGE="$MESSAGE
            üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: [$(
              for i in $(seq 1 10); do
                if [ $((i*10)) -le $PERCENTAGE ]; then
                  echo "‚ñà"
                else
                  echo "‚ñë"
                fi
              done | tr -d '\n'
            )] $PERCENTAGE%"
          
            if [ $TESTS_FAILED -gt 0 ]; then
              # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
              FAILED_TESTS=$(jq -r '.failures[] | .title' cypress/results/results.json 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫")
              MESSAGE="$MESSAGE
          
            üî• <b>–£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:</b>
            $FAILED_TESTS"
            fi
          
          else
            # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –Ω–µ—Ç
            MESSAGE="üß™ <b>Cypress Tests Results</b>
            ========================
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          
            ‚ö†Ô∏è –§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
            –°—Ç–∞—Ç—É—Å: ${{ job.status }}"
          fi
          
          MESSAGE="$MESSAGE
          
          ------------------------
          üîó –î–µ—Ç–∞–ª–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          curl -s -X POST \
            https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"