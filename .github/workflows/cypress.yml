name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq for JSON parsing
        run: sudo apt-get install -y jq  # ‚¨Ö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ jq

      - name: Run Cypress tests with JSON report
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          command: npm run test:e2e  # ‚¨ÖÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

      - name: Send detailed Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          RESULT_FILE=""

          for file in "cypress/results/results.json" "cypress/reports/results.json" "test-results.json" "cypress.json"; do
            if [ -f "$file" ]; then
              RESULT_FILE="$file"
              echo "–ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: $RESULT_FILE"
              break
            fi
          done

          if [ -n "$RESULT_FILE" ]; then
            echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ JSON —Ñ–∞–π–ª–∞ ==="
            cat "$RESULT_FILE" | jq '.' | head -50

            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON
            # –í–∞—Ä–∏–∞–Ω—Ç 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ mochawesome
            TESTS_TOTAL=$(jq -r '.stats.tests // .total // 0' "$RESULT_FILE" 2>/dev/null || echo "0")
            TESTS_PASSED=$(jq -r '.stats.passes // .passed // 0' "$RESULT_FILE" 2>/dev/null || echo "0")
            TESTS_FAILED=$(jq -r '.stats.failures // .failed // 0' "$RESULT_FILE" 2>/dev/null || echo "0")

            echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Å–µ–≥–æ=$TESTS_TOTAL, –ü—Ä–æ–π–¥–µ–Ω–æ=$TESTS_PASSED, –£–ø–∞–ª–æ=$TESTS_FAILED"

            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
            if [ "$TESTS_TOTAL" = "0" ] || [ "$TESTS_TOTAL" = "null" ]; then
              echo "–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥..."
              # –ò—â–µ–º –≤ –º–∞—Å—Å–∏–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
              TESTS_TOTAL=$(jq -r '[.[] | .stats.tests] | add // 0' "$RESULT_FILE" 2>/dev/null || echo "0")
              TESTS_PASSED=$(jq -r '[.[] | .stats.passes] | add // 0' "$RESULT_FILE" 2>/dev/null || echo "0")
              TESTS_FAILED=$(jq -r '[.[] | .stats.failures] | add // 0' "$RESULT_FILE" 2>/dev/null || echo "0")
            fi
          else
            echo "–§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            TESTS_TOTAL="N/A"
            TESTS_PASSED="N/A"
            TESTS_FAILED="N/A"
          fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–Ω–∞—á–µ–Ω–∏–π
          if [ "$TESTS_TOTAL" != "N/A" ] && [ "$TESTS_TOTAL" != "null" ] && [ "$TESTS_TOTAL" != "0" ]; then
            PERCENTAGE=$((TESTS_PASSED * 100 / TESTS_TOTAL))
            PROGRESS_BAR="$(
              for i in $(seq 1 10); do
                if [ $((i*10)) -le $PERCENTAGE ]; then
                  echo "‚ñà"
                else
                  echo "‚ñë"
                fi
              done | tr -d '\n'
            )"
          else
            PERCENTAGE=0
            PROGRESS_BAR="‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë"
          fi

          MESSAGE="üß™ <b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç Cypress Tests</b>
          ==============================
          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}

          üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</b>
          ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $TESTS_PASSED –∏–∑ $TESTS_TOTAL
          ‚ùå –£–ø–∞–ª–æ: $TESTS_FAILED –∏–∑ $TESTS_TOTAL

          üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: [$PROGRESS_BAR] $PERCENTAGE%"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          curl -s -X POST \
            https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"