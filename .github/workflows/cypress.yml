name: Cypress Tests
on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false

      - name: Install jq for JSON parsing
        run: sudo apt-get install -y jq

      - name: Run Cypress tests with JSON report
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
          command: npm run test:e2e

      # ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –®–ê–ì –û–¢–õ–ê–î–ö–ò –ó–î–ï–°–¨ ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
      - name: Debug JSON structure
        if: always()
        run: |
          echo "=== –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É ==="
          pwd
          find . -name "results.json" -type f
          
          echo "=== –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É cypress ==="
          ls -la cypress/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ cypress –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          ls -la cypress/results/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ results –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ results.json ==="
          if [ -f "cypress/results/results.json" ]; then
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < "cypress/results/results.json") —Å—Ç—Ä–æ–∫"
            echo "–†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö: $(wc -c < "cypress/results/results.json")"
            echo "=== –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ ==="
            head -n 10 "cypress/results/results.json"
            echo "=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ ==="
            tail -n 10 "cypress/results/results.json"
            echo "=== –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ jq ==="
            jq -r '.' "cypress/results/results.json" 2>/dev/null | head -n 50 || echo "jq –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ñ–∞–π–ª"
            echo "=== –ö–ª—é—á–∏ –≤ JSON ==="
            jq -r 'keys[]' "cypress/results/results.json" 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á–∏"
          else
            echo "–§–∞–π–ª cypress/results/results.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            # –ò—â–µ–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
            echo "=== –ò—â–µ–º –≤—Å–µ JSON —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ ==="
            find . -name "*.json" -type f | grep -i "result\|report\|test" | head -20
          fi
      # ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è –ö–û–ù–ï–¶ –®–ê–ì–ê –û–¢–õ–ê–î–ö–ò ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

      - name: Send detailed Telegram notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          TESTS_TOTAL=0
          TESTS_PASSED=0
          TESTS_FAILED=0

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
          if [ -f "cypress/results/results.json" ]; then
            echo "–§–∞–π–ª –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å..."

            # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            echo "=== –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ —Ñ–∞–π–ª–∞ ==="
            head -c 100 "cypress/results/results.json"
            echo ""

            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
            # 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Cypress JSON –æ—Ç—á–µ—Ç
            if jq -e '.stats' "cypress/results/results.json" > /dev/null 2>&1; then
              echo "–ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ .stats"
              TESTS_TOTAL=$(jq -r '.stats.tests // 0' "cypress/results/results.json")
              TESTS_PASSED=$(jq -r '.stats.passes // 0' "cypress/results/results.json")
              TESTS_FAILED=$(jq -r '.stats.failures // 0' "cypress/results/results.json")

            # 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–º–∞—Å—Å–∏–≤)
            elif jq -e '.[0]' "cypress/results/results.json" > /dev/null 2>&1; then
              echo "–ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∞—Å—Å–∏–≤–∞"
              TESTS_TOTAL=$(jq -r '[.[] | .stats.tests] | add // 0' "cypress/results/results.json")
              TESTS_PASSED=$(jq -r '[.[] | .stats.passes] | add // 0' "cypress/results/results.json")
              TESTS_FAILED=$(jq -r '[.[] | .stats.failures] | add // 0' "cypress/results/results.json")

            # 3. –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            else
              echo "–ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É"
              TESTS_TOTAL=$(jq -r '.total // .tests // 0' "cypress/results/results.json")
              TESTS_PASSED=$(jq -r '.passed // .passes // 0' "cypress/results/results.json")
              TESTS_FAILED=$(jq -r '.failed // .failures // 0' "cypress/results/results.json")
            fi

            echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞: –í—Å–µ–≥–æ=$TESTS_TOTAL, –ü—Ä–æ–π–¥–µ–Ω–æ=$TESTS_PASSED, –£–ø–∞–ª–æ=$TESTS_FAILED"
          else
            echo "–§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤—ã–µ
          TESTS_TOTAL=${TESTS_TOTAL:-0}
          TESTS_PASSED=${TESTS_PASSED:-0}
          TESTS_FAILED=${TESTS_FAILED:-0}

          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
          TESTS_TOTAL=$((TESTS_TOTAL))
          TESTS_PASSED=$((TESTS_PASSED))
          TESTS_FAILED=$((TESTS_FAILED))

          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã
          if [ $TESTS_TOTAL -gt 0 ]; then
            PERCENTAGE=$((TESTS_PASSED * 100 / TESTS_TOTAL))
            PROGRESS_BAR="$(
              for i in $(seq 1 10); do
                if [ $((i*10)) -le $PERCENTAGE ]; then
                  echo "‚ñà"
                else
                  echo "‚ñë"
                fi
              done | tr -d '\n'
            )"
          else
            PERCENTAGE=0
            PROGRESS_BAR="‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë"
            TESTS_TOTAL="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
          fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üß™ <b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç Cypress Tests</b>
          ==============================
          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}

          üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</b>
          ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $TESTS_PASSED –∏–∑ $TESTS_TOTAL
          ‚ùå –£–ø–∞–ª–æ: $TESTS_FAILED –∏–∑ $TESTS_TOTAL"

          if [ "$TESTS_TOTAL" != "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ] && [ $TESTS_TOTAL -gt 0 ]; then
            MESSAGE="$MESSAGE

          üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: [$PROGRESS_BAR] $PERCENTAGE%"
          fi

          # –î–æ–±–∞–≤–ª—è–µ–º —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
          if [ $TESTS_FAILED -gt 0 ] && [ -f "cypress/results/results.json" ]; then
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–º–µ–Ω–∞ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
            FAILED_TESTS=$(jq -r '
              if .stats then
                # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ stats
                [.results[].suites[].tests[] | select(.fail == true) | .title] | join("\n")
              elif .[0] then
                # –ú–∞—Å—Å–∏–≤–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                [.[].results[].suites[].tests[] | select(.state == "failed") | .title] | join("\n")
              else
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤"
              end
            ' "cypress/results/results.json" 2>/dev/null || echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞")

            if [ -n "$FAILED_TESTS" ] && [ "$FAILED_TESTS" != "" ]; then
              MESSAGE="$MESSAGE

          üî• <b>–£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:</b>
          $FAILED_TESTS"
            fi
          fi

          MESSAGE="$MESSAGE

          ------------------------
          üîó –î–µ—Ç–∞–ª–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
          curl -s -X POST \
            https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"